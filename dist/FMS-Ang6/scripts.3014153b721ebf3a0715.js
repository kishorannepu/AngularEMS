var Hammer=require("hammerjs");Hammer="function"==typeof Hammer?Hammer:window.Hammer;var Chart=require("chart.js"),helpers=(Chart="function"==typeof Chart?Chart:window.Chart).helpers,zoomNS=Chart.Zoom=Chart.Zoom||{},zoomFunctions=zoomNS.zoomFunctions=zoomNS.zoomFunctions||{},panFunctions=zoomNS.panFunctions=zoomNS.panFunctions||{},defaultOptions=zoomNS.defaults={pan:{enabled:!0,mode:"xy",speed:20,threshold:10},zoom:{enabled:!0,mode:"xy",sensitivity:3}};function directionEnabled(e,o){return void 0===e||"string"==typeof e&&-1!==e.indexOf(o)}function rangeMaxLimiter(e,o){if(e.scaleAxes&&e.rangeMax&&!helpers.isNullOrUndef(e.rangeMax[e.scaleAxes])){var t=e.rangeMax[e.scaleAxes];o>t&&(o=t)}return o}function rangeMinLimiter(e,o){if(e.scaleAxes&&e.rangeMin&&!helpers.isNullOrUndef(e.rangeMin[e.scaleAxes])){var t=e.rangeMin[e.scaleAxes];o<t&&(o=t)}return o}function zoomIndexScale(e,o,t,n){var a=e.chart.data.labels,i=e.minIndex,m=a.length-1,r=e.maxIndex,l=n.sensitivity,s=e.isHorizontal()?e.left+e.width/2:e.top+e.height/2,u=e.isHorizontal()?t.x:t.y;zoomNS.zoomCumulativeDelta=o>1?zoomNS.zoomCumulativeDelta+1:zoomNS.zoomCumulativeDelta-1,Math.abs(zoomNS.zoomCumulativeDelta)>l&&(zoomNS.zoomCumulativeDelta<0?(u>=s?i<=0?r=Math.min(m,r+1):i=Math.max(0,i-1):u<s&&(r>=m?i=Math.max(0,i-1):r=Math.min(m,r+1)),zoomNS.zoomCumulativeDelta=0):zoomNS.zoomCumulativeDelta>0&&(u>=s?i=i<r?i=Math.min(r,i+1):i:u<s&&(r=r>i?r=Math.max(i,r-1):r),zoomNS.zoomCumulativeDelta=0),e.options.ticks.min=rangeMinLimiter(n,a[i]),e.options.ticks.max=rangeMaxLimiter(n,a[r]))}function zoomTimeScale(e,o,t,n){var a,i,m=e.options;i=e.isHorizontal()?(t.x-e.left)/(a=e.right-e.left):(t.y-e.top)/(a=e.bottom-e.top);var r=a*(o-1),l=r*i,s=r*(1-i),u=e.getValueForPixel(e.getPixelForValue(e.min)+l),c=e.getValueForPixel(e.getPixelForValue(e.max)-s),d=c.diff(u),p=rangeMinLimiter(n,d)!=d,z=rangeMaxLimiter(n,d)!=d;p||z||(m.time.min=u,m.time.max=c)}function zoomNumericalScale(e,o,t,n){var a=e.max-e.min,i=a*(o-1),m=e.isHorizontal()?t.x:t.y,r=(e.getValueForPixel(m)-e.min)/a,l=i*(1-r);e.options.ticks.min=rangeMinLimiter(n,e.min+i*r),e.options.ticks.max=rangeMaxLimiter(n,e.max-l)}function zoomScale(e,o,t,n){var a=zoomFunctions[e.options.type];a&&a(e,o,t,n)}function doZoom(e,o,t,n){var a=e.chartArea;t||(t={x:(a.left+a.right)/2,y:(a.top+a.bottom)/2});var i=e.options.zoom;if(i&&helpers.getValueOrDefault(i.enabled,defaultOptions.zoom.enabled)){var m,r=helpers.getValueOrDefault(e.options.zoom.mode,defaultOptions.zoom.mode);i.sensitivity=helpers.getValueOrDefault(e.options.zoom.sensitivity,defaultOptions.zoom.sensitivity),m="xy"==r&&void 0!==n?n:"xy",helpers.each(e.scales,function(e,n){e.isHorizontal()&&directionEnabled(r,"x")&&directionEnabled(m,"x")?(i.scaleAxes="x",zoomScale(e,o,t,i)):!e.isHorizontal()&&directionEnabled(r,"y")&&directionEnabled(m,"y")&&(i.scaleAxes="y",zoomScale(e,o,t,i))}),e.update(0),"function"==typeof i.onZoom&&i.onZoom()}}function panIndexScale(e,o,t){var n,a=e.chart.data.labels,i=a.length-1,m=Math.max(e.ticks.length-(e.options.gridLines.offsetGridLines?0:1),1),r=e.minIndex,l=Math.round(e.width/(m*t.speed));zoomNS.panCumulativeDelta+=o,r=zoomNS.panCumulativeDelta>l?Math.max(0,r-1):zoomNS.panCumulativeDelta<-l?Math.min(i-m+1,r+1):r,zoomNS.panCumulativeDelta=r!==e.minIndex?0:zoomNS.panCumulativeDelta,n=Math.min(i,r+m-1),e.options.ticks.min=rangeMinLimiter(t,a[r]),e.options.ticks.max=rangeMaxLimiter(t,a[n])}function panTimeScale(e,o,t){var n=e.options,a=rangeMaxLimiter(t,e.getValueForPixel(e.getPixelForValue(e.max)-o)),i=rangeMinLimiter(t,e.getValueForPixel(e.getPixelForValue(e.min)-o)),m=o<0?a-e.max:i-e.min;n.time.max=e.max+m,n.time.min=e.min+m}function panNumericalScale(e,o,t){var n=e.options.ticks,a=e.start,i=e.end;n.reverse?(n.max=e.getValueForPixel(e.getPixelForValue(a)-o),n.min=e.getValueForPixel(e.getPixelForValue(i)-o)):(n.min=e.getValueForPixel(e.getPixelForValue(a)-o),n.max=e.getValueForPixel(e.getPixelForValue(i)-o)),n.min=rangeMinLimiter(t,n.min),n.max=rangeMaxLimiter(t,n.max)}function panScale(e,o,t){var n=panFunctions[e.options.type];n&&n(e,o,t)}function doPan(e,o,t){var n=e.options.pan;if(n&&helpers.getValueOrDefault(n.enabled,defaultOptions.pan.enabled)){var a=helpers.getValueOrDefault(e.options.pan.mode,defaultOptions.pan.mode);n.speed=helpers.getValueOrDefault(e.options.pan.speed,defaultOptions.pan.speed),helpers.each(e.scales,function(e,i){e.isHorizontal()&&directionEnabled(a,"x")&&0!==o?(n.scaleAxes="x",panScale(e,o,n)):!e.isHorizontal()&&directionEnabled(a,"y")&&0!==t&&(n.scaleAxes="y",panScale(e,t,n))}),e.update(0),"function"==typeof n.onPan&&n.onPan()}}function positionInChartArea(e,o){return o.x>=e.chartArea.left&&o.x<=e.chartArea.right&&o.y>=e.chartArea.top&&o.y<=e.chartArea.bottom}function getYAxis(e){var o=e.scales;for(var t in o){var n=o[t];if(!n.isHorizontal())return n}}zoomNS.zoomFunctions.category=zoomIndexScale,zoomNS.zoomFunctions.time=zoomTimeScale,zoomNS.zoomFunctions.linear=zoomNumericalScale,zoomNS.zoomFunctions.logarithmic=zoomNumericalScale,zoomNS.panFunctions.category=panIndexScale,zoomNS.panFunctions.time=panTimeScale,zoomNS.panFunctions.linear=panNumericalScale,zoomNS.panFunctions.logarithmic=panNumericalScale,zoomNS.panCumulativeDelta=0,zoomNS.zoomCumulativeDelta=0;var zoomPlugin={id:"zoom",afterInit:function(e){helpers.each(e.scales,function(e){e.originalOptions=helpers.clone(e.options)}),e.resetZoom=function(){helpers.each(e.scales,function(e,o){var t=e.options.time,n=e.options.ticks;t&&(t.min=e.originalOptions.time.min,t.max=e.originalOptions.time.max),n&&(n.min=e.originalOptions.ticks.min,n.max=e.originalOptions.ticks.max)}),helpers.each(e.data.datasets,function(e,o){e._meta=null}),e.update()}},beforeInit:function(e){e.zoom={};var o=e.zoom.node=e.chart.ctx.canvas,t=e.options,n=helpers.getValueOrDefault(t.pan?t.pan.threshold:void 0,zoomNS.defaults.pan.threshold);if(t.zoom&&t.zoom.enabled&&(t.zoom.drag?(t.zoom.mode="x",e.zoom._mouseDownHandler=function(o){e.zoom._dragZoomStart=o},o.addEventListener("mousedown",e.zoom._mouseDownHandler),e.zoom._mouseMoveHandler=function(o){e.zoom._dragZoomStart&&(e.zoom._dragZoomEnd=o,e.update(0))},o.addEventListener("mousemove",e.zoom._mouseMoveHandler),e.zoom._mouseUpHandler=function(o){if(e.zoom._dragZoomStart){var t=e.chartArea,n=getYAxis(e),a=e.zoom._dragZoomStart,i=a.target.getBoundingClientRect().left,m=Math.min(a.clientX,o.clientX)-i,r=Math.max(a.clientX,o.clientX)-i-m,l=t.right-t.left,s=1+(l-r)/l;e.zoom._dragZoomStart=null,e.zoom._dragZoomEnd=null,r>0&&doZoom(e,s,{x:r/2+m,y:(n.bottom-n.top)/2})}},o.addEventListener("mouseup",e.zoom._mouseUpHandler)):(e.zoom._wheelHandler=function(o){var t=o.target.getBoundingClientRect();doZoom(e,o.deltaY<0?1.1:.909,{x:o.clientX-t.left,y:o.clientY-t.top}),o.preventDefault()},o.addEventListener("wheel",e.zoom._wheelHandler)),Hammer)){var a,i=new Hammer.Manager(o);i.add(new Hammer.Pinch),i.add(new Hammer.Pan({threshold:n}));var m=function(o){var t=1/a*o.scale,n=o.target.getBoundingClientRect(),i={x:o.center.x-n.left,y:o.center.y-n.top},m=Math.abs(o.pointers[0].clientX-o.pointers[1].clientX),r=Math.abs(o.pointers[0].clientY-o.pointers[1].clientY),l=m/r;doZoom(e,t,i,l>.3&&l<1.7?"xy":m>r?"x":"y"),a=o.scale};i.on("pinchstart",function(e){a=1}),i.on("pinch",m),i.on("pinchend",function(e){m(e),a=null,zoomNS.zoomCumulativeDelta=0});var r=null,l=null,s=!1,u=function(o){if(null!==r&&null!==l){s=!0;var t=o.deltaX-r,n=o.deltaY-l;r=o.deltaX,l=o.deltaY,doPan(e,t,n)}};i.on("panstart",function(e){r=0,l=0,u(e)}),i.on("panmove",u),i.on("panend",function(e){r=null,l=null,zoomNS.panCumulativeDelta=0,setTimeout(function(){s=!1},500)}),e.zoom._ghostClickHandler=function(e){s&&(e.stopImmediatePropagation(),e.preventDefault())},o.addEventListener("click",e.zoom._ghostClickHandler),e._mc=i}},beforeDatasetsDraw:function(e){var o=e.chart.ctx,t=e.chartArea;if(o.save(),o.beginPath(),e.zoom._dragZoomEnd){var n=getYAxis(e),a=e.zoom._dragZoomStart,i=e.zoom._dragZoomEnd,m=a.target.getBoundingClientRect().left,r=Math.min(a.clientX,i.clientX)-m,l=Math.max(a.clientX,i.clientX)-m-r;o.fillStyle="rgba(225,225,225,0.3)",o.lineWidth=5,o.fillRect(r,n.top,l,n.bottom-n.top)}o.rect(t.left,t.top,t.right-t.left,t.bottom-t.top),o.clip()},afterDatasetsDraw:function(e){e.chart.ctx.restore()},destroy:function(e){if(e.zoom){var o=e.options,t=e.zoom.node;o.zoom&&o.zoom.drag?(t.removeEventListener("mousedown",e.zoom._mouseDownHandler),t.removeEventListener("mousemove",e.zoom._mouseMoveHandler),t.removeEventListener("mouseup",e.zoom._mouseUpHandler)):t.removeEventListener("wheel",e.zoom._wheelHandler),Hammer&&t.removeEventListener("click",e.zoom._ghostClickHandler),delete e.zoom;var n=e._mc;n&&(n.remove("pinchstart"),n.remove("pinch"),n.remove("pinchend"),n.remove("panstart"),n.remove("pan"),n.remove("panend"))}}};module.exports=zoomPlugin,Chart.pluginService.register(zoomPlugin);